name: ðŸŒ‰ Issue Trigger Bridge v2

# Fixed: Uses GitHub API directly instead of gh CLI

on:
  issue_comment:
    types: [created]

permissions:
  actions: write
  contents: read
  issues: write

jobs:
  bridge-trigger:
    if: github.event.issue.number == 24
    runs-on: ubuntu-latest
    
    steps:
      - name: Parse Trigger Command
        id: parse
        env:
          COMMENT: ${{ github.event.comment.body }}
          ACTOR: ${{ github.event.comment.user.login }}
        run: |
          echo "Comment from: $ACTOR"
          echo "Comment body: $COMMENT"
          
          if echo "$COMMENT" | grep -qi "TRIGGER_BOOTSTRAP"; then
            echo "command=bootstrap" >> $GITHUB_OUTPUT
            echo "âœ… Bootstrap trigger detected"
          fi

      - name: Trigger Self-Deploying Bootstrap via API
        if: steps.parse.outputs.command == 'bootstrap'
        run: |
          echo "ðŸš€ Triggering self-deploying-bootstrap.yml via GitHub API..."
          
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ github.token }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/self-deploying-bootstrap.yml/dispatches \
            -d '{"ref":"main"}'
          
          echo "âœ… Workflow dispatch request sent"

      - name: Confirm Trigger
        if: steps.parse.outputs.command == 'bootstrap'
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ github.token }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ github.repository }}/issues/24/comments \
            -d '{
              "body": "## ðŸš€ Autonomous Bootstrap Triggered\n\n**Trigger received from:** @${{ github.event.comment.user.login }}\n**Time:** '"$(date -u +"%Y-%m-%d %H:%M:%S UTC")"'\n\n---\n\nThe Self-Deploying Bootstrap Agent is now running.\n\n**Track progress:**\nhttps://github.com/${{ github.repository }}/actions/workflows/self-deploying-bootstrap.yml\n\n**What happens next:**\n1. Phase 1: System generates all deployment code\n2. Phase 2: System posts deployment plan HERE  \n3. Phase 3: System deploys Railway Broker to GCP\n\n---\n\n**Zero human intervention beyond this point.**\n\n*Triggered autonomously via IssueOps Bridge v2 (API)*"
            }'
