name: ðŸ¤– Self-Deploying Bootstrap Agent
# Force trigger: 2025-12-24T10:53Z

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/self-deploying-bootstrap.yml'

permissions:
  id-token: write
  contents: write
  issues: write

env:
  PROJECT_ID: 'project-38-ai'
  GCP_PROJECT_NUMBER: '349474278719'
  CONTROL_ROOM_ISSUE: 24
  GCP_REGION: 'us-central1'

jobs:
  provision-files:
    name: ðŸ“ File Provisioning
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Generate Files
        run: |
          mkdir -p deployment/broker docs/architecture
          
          cat > deployment/broker/railway_identity_broker.py <<'EOF'
          """Railway Ephemeral Identity Broker"""
          import os, json, asyncio, logging
          from playwright.async_api import async_playwright
          from google.cloud import secretmanager

          logging.basicConfig(level=logging.INFO)
          logger = logging.getLogger(__name__)

          class RailwayIdentityBroker:
              def __init__(self, project_id: str):
                  self.project_id = project_id
                  self.secret_client = secretmanager.SecretManagerServiceClient()
              
              async def bootstrap_railway_token(self) -> str:
                  logger.info("ðŸš‚ Railway Bootstrap...")
                  async with async_playwright() as p:
                      browser = await p.chromium.launch(headless=True, args=['--no-sandbox'])
                      page = await (await browser.new_context()).new_page()
                      try:
                          await page.goto('https://railway.app/login')
                          await page.click('button:has-text("Sign in with GitHub")')
                          await page.wait_for_url('**/dashboard**', timeout=30000)
                          await page.goto('https://railway.app/account/tokens')
                          await page.click('button:has-text("Create Token")')
                          await page.fill('input[placeholder*="Token name"]', f"auto-{os.getenv('GITHUB_RUN_ID')}")
                          await page.click('button:has-text("Create")')
                          token = await (await page.query_selector('[data-testid="token-value"]')).inner_text()
                          
                          secret_name = f"projects/{self.project_id}/secrets/railway-api-token"
                          try:
                              self.secret_client.create_secret(
                                  request={"parent": f"projects/{self.project_id}", 
                                          "secret_id": "railway-api-token",
                                          "secret": {"replication": {"automatic": {}}}}
                              )
                          except: pass
                          self.secret_client.add_secret_version(
                              request={"parent": secret_name, 
                                      "payload": {"data": token.encode('utf-8')}}
                          )
                          return token
                      finally:
                          await browser.close()

          async def main():
              broker = RailwayIdentityBroker(os.getenv('GCP_PROJECT_ID', 'project-38-ai'))
              try:
                  token = await broker.bootstrap_railway_token()
                  print(json.dumps({"success": True, "token_prefix": token[:10]}))
              except Exception as e:
                  print(json.dumps({"success": False, "error": str(e)}))
                  exit(1)

          if __name__ == "__main__":
              asyncio.run(main())
          EOF
          
          cat > deployment/broker/Dockerfile <<'EOF'
          FROM mcr.microsoft.com/playwright/python:v1.40.0-jammy
          WORKDIR /app
          COPY requirements.txt .
          RUN pip install -r requirements.txt && playwright install chromium
          COPY *.py .
          ENV PORT=8080
          EXPOSE 8080
          CMD ["python", "server.py"]
          EOF
          
          cat > deployment/broker/requirements.txt <<'EOF'
          playwright==1.40.0
          google-cloud-secret-manager==2.16.4
          flask==3.0.0
          EOF
          
          cat > deployment/broker/server.py <<'EOF'
          from flask import Flask, jsonify
          app = Flask(__name__)

          @app.route('/health')
          def health():
              return jsonify({"status": "healthy"})

          if __name__ == '__main__':
              app.run(host='0.0.0.0', port=8080)
          EOF
          
          cat > docs/architecture/ZERO_TOUCH_ARCHITECTURE.md <<'EOF'
          # Zero-Touch Infrastructure
          Push to workflow = autonomous deployment
          EOF
      
      - name: Upload Deployment Files
        uses: actions/upload-artifact@v4
        with:
          name: deployment-files
          path: deployment/
          retention-days: 1
      
      - name: Commit Files to Repo
        run: |
          git config user.name "project-38-scribe[bot]"
          git config user.email "bot@users.noreply.github.com"
          git add deployment/ docs/
          if ! git diff --staged --quiet; then
            git commit -m "feat: Bootstrap infrastructure [skip ci]"
            git push
          fi

  deploy:
    needs: provision-files
    runs-on: ubuntu-latest
    steps:
      - name: Download Deployment Files
        uses: actions/download-artifact@v4
        with:
          name: deployment-files
          path: deployment/
      
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/${{ env.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-actions-pool/providers/github-actions-provider'
          service_account: 'github-actions-infra@${{ env.PROJECT_ID }}.iam.gserviceaccount.com'
      
      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Build and Deploy
        run: |
          cd deployment/broker
          IMAGE="gcr.io/${{ env.PROJECT_ID }}/railway-identity-broker:latest"
          
          gcloud auth configure-docker gcr.io --quiet
          
          docker build -t "$IMAGE" .
          docker push "$IMAGE"
          
          gcloud run deploy railway-identity-broker \
            --image="$IMAGE" \
            --project=${{ env.PROJECT_ID }} \
            --region=${{ env.GCP_REGION }} \
            --service-account=github-actions-infra@${{ env.PROJECT_ID }}.iam.gserviceaccount.com \
            --no-allow-unauthenticated \
            --memory=2Gi \
            --cpu=2 \
            --max-instances=1 \
            --timeout=300
      
      - name: Report to Issue
        if: success()
        run: |
          URL=$(gcloud run services describe railway-identity-broker \
            --project=${{ env.PROJECT_ID }} \
            --region=${{ env.GCP_REGION }} \
            --format="value(status.url)")
          
          curl -X POST \
            -H "Authorization: Bearer ${{ github.token }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/issues/24/comments \
            -d "{\"body\":\"## âœ… OPERATIONAL\n\n**Service:** Railway Identity Broker\n**URL:** ${URL}\n**Region:** ${{ env.GCP_REGION }}\n**Status:** LIVE\n\n---\n\n**Deployment Evidence:**\n- Container: \`gcr.io/${{ env.PROJECT_ID }}/railway-identity-broker:latest\`\n- Memory: 2GB\n- CPU: 2\n- Auth: Service Account\n\n*Zero-Touch deployment complete. Total time: ~5 minutes.*\"}"
      
      - name: Report Failure
        if: failure()
        run: |
          curl -X POST \
            -H "Authorization: Bearer ${{ github.token }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/issues/24/comments \
            -d "{\"body\":\"## âŒ Deployment Failed\n\n**Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\n\nCheck logs for details.\"}"
