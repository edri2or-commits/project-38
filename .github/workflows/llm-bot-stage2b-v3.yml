name: LLM Bot - Stage 2B v4

on:
  issue_comment:
    types: [created]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write
  issues: write

jobs:
  smoke-test:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Workflow Registration Verification
        run: |
          echo "::notice::workflow_dispatch test PASSED"
          echo "Event: ${{ github.event_name }}"
          echo "Actor: ${{ github.actor }}"

  llm-response:
    if: github.event_name == 'issue_comment' && github.event.issue.number == 24
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Bot Guard
        id: bot_check
        run: |
          if [ "${{ github.event.comment.user.type }}" == "Bot" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Concurrency Lock Check
        id: lock_check
        if: steps.bot_check.outputs.skip == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          LABELS=$(gh api repos/${{ github.repository }}/issues/24 --jq '.labels[].name')
          if echo "$LABELS" | grep -q "^processing$"; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "::notice::Skipping: Another workflow is processing"
            COMMENT="Concurrency Lock Active - Another workflow is currently processing. Please wait. <!-- P38_CONCURRENCY_LOCK: comment_${{ github.event.comment.id }} -->"
            gh api --method POST -H "Accept: application/vnd.github+json" /repos/${{ github.repository }}/issues/24/comments -f body="$COMMENT"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Acquire Lock
        id: acquire_lock
        if: steps.bot_check.outputs.skip == 'false' && steps.lock_check.outputs.skip == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api --method POST /repos/${{ github.repository }}/issues/24/labels -f labels[]="processing"
          gh api --method DELETE /repos/${{ github.repository }}/issues/24/labels/queued 2>/dev/null || true
          echo "::notice::Lock acquired"

      - name: Idempotency Check
        id: idempotency_check
        if: steps.bot_check.outputs.skip == 'false' && steps.lock_check.outputs.skip == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          COMMENT_ID="${{ github.event.comment.id }}"
          MARKER="P38_IDEMPOTENCY_KEY: comment_${COMMENT_ID}"
          FOUND=$(gh api repos/${{ github.repository }}/issues/24/comments --jq ".[] | select(.body | contains(\"$MARKER\")) | .id" | head -n 1)
          if [ -n "$FOUND" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Access Control
        id: access_check
        if: steps.bot_check.outputs.skip == 'false' && steps.lock_check.outputs.skip == 'false' && steps.idempotency_check.outputs.skip == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          USERNAME="${{ github.event.comment.user.login }}"
          PERMISSION=$(gh api repos/${{ github.repository }}/collaborators/${USERNAME}/permission --jq '.permission' 2>/dev/null || echo "none")
          if [[ "$PERMISSION" == "admin" || "$PERMISSION" == "write" ]]; then
            echo "skip=false" >> $GITHUB_OUTPUT
          else
            echo "skip=true" >> $GITHUB_OUTPUT
          fi

      - name: Command Guard
        id: command_check
        if: steps.bot_check.outputs.skip == 'false' && steps.lock_check.outputs.skip == 'false' && steps.idempotency_check.outputs.skip == 'false' && steps.access_check.outputs.skip == 'false'
        run: |
          BODY=$(jq -r '.comment.body' "$GITHUB_EVENT_PATH")
          if echo "$BODY" | grep -qE '^\s*/ask|^\s*/plan'; then
            echo "skip=false" >> $GITHUB_OUTPUT
          else
            echo "skip=true" >> $GITHUB_OUTPUT
          fi

      - name: Checkout
        id: checkout
        if: steps.bot_check.outputs.skip == 'false' && steps.lock_check.outputs.skip == 'false' && steps.idempotency_check.outputs.skip == 'false' && steps.access_check.outputs.skip == 'false' && steps.command_check.outputs.skip == 'false'
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        id: auth_gcp
        if: steps.bot_check.outputs.skip == 'false' && steps.lock_check.outputs.skip == 'false' && steps.idempotency_check.outputs.skip == 'false' && steps.access_check.outputs.skip == 'false' && steps.command_check.outputs.skip == 'false'
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/673161610630/locations/global/workloadIdentityPools/github-actions-pool/providers/github-actions-provider'
          service_account: 'github-actions-llm@project-38-ai.iam.gserviceaccount.com'

      - name: Get secrets
        id: secrets
        if: steps.bot_check.outputs.skip == 'false' && steps.lock_check.outputs.skip == 'false' && steps.idempotency_check.outputs.skip == 'false' && steps.access_check.outputs.skip == 'false' && steps.command_check.outputs.skip == 'false'
        uses: google-github-actions/get-secretmanager-secrets@v2
        with:
          secrets: |-
            ANTHROPIC_API_KEY:project-38-ai/anthropic-api-key

      - name: Set up Python
        id: setup_python
        if: steps.bot_check.outputs.skip == 'false' && steps.lock_check.outputs.skip == 'false' && steps.idempotency_check.outputs.skip == 'false' && steps.access_check.outputs.skip == 'false' && steps.command_check.outputs.skip == 'false'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        id: install_deps
        if: steps.bot_check.outputs.skip == 'false' && steps.lock_check.outputs.skip == 'false' && steps.idempotency_check.outputs.skip == 'false' && steps.access_check.outputs.skip == 'false' && steps.command_check.outputs.skip == 'false'
        run: pip install anthropic

      - name: Generate response
        id: generate_response
        if: steps.bot_check.outputs.skip == 'false' && steps.lock_check.outputs.skip == 'false' && steps.idempotency_check.outputs.skip == 'false' && steps.access_check.outputs.skip == 'false' && steps.command_check.outputs.skip == 'false'
        timeout-minutes: 3
        env:
          ANTHROPIC_API_KEY: ${{ steps.secrets.outputs.ANTHROPIC_API_KEY }}
        run: |
          python3 << 'PYTHON_EOF'
          import os, json, time, sys
          from anthropic import Anthropic

          MAX_RETRIES = 3
          BASE_DELAY = 2
          CONTEXT_LIMIT = 4000

          with open(os.environ['GITHUB_EVENT_PATH']) as f:
              event = json.load(f)

          body = event['comment']['body']
          user = event['comment']['user']['login']
          cid = event['comment']['id']
          cmd = body.strip().split('\n')[0]
          query = body[len(cmd):].strip() if len(body) > len(cmd) else cmd

          # Budget guard: truncate query
          truncated = False
          if len(query) > CONTEXT_LIMIT:
              query = query[:CONTEXT_LIMIT]
              truncated = True

          client = Anthropic(api_key=os.environ['ANTHROPIC_API_KEY'])

          # Retry logic with exponential backoff
          for attempt in range(1, MAX_RETRIES + 1):
              try:
                  print(f"::notice::LLM request attempt {attempt}/{MAX_RETRIES}")
                  msg = client.messages.create(
                      model='claude-sonnet-4-20250514',
                      max_tokens=800,
                      messages=[{'role': 'user', 'content': f'Project 38 IssueOps: @{user} asked: {query}'}]
                  )
                  text = msg.content[0].text

                  # Success - prepare output
                  truncation_notice = '\n\n⚠️ Context truncated to 4000 chars' if truncated else ''
                  output = f'**LLM Response (v4)**\n\n{text}{truncation_notice}\n\n---\n*Command: {cmd.split()[0]}*\n<!-- P38_IDEMPOTENCY_KEY: comment_{cid} -->'

                  with open(os.environ['GITHUB_ENV'], 'a') as f:
                      f.write(f'LLM_RESPONSE<<EOF\n{output}\nEOF\n')

                  print('::notice::Generated successfully')
                  sys.exit(0)

              except Exception as e:
                  print(f"::error::Attempt {attempt} failed: {str(e)}")

                  if attempt < MAX_RETRIES:
                      delay = BASE_DELAY ** attempt
                      print(f"::notice::Retrying in {delay}s...")
                      time.sleep(delay)
                  else:
                      print(f"::error::All {MAX_RETRIES} attempts failed")
                      sys.exit(1)
          PYTHON_EOF

      - name: Post response
        id: post_response
        if: steps.bot_check.outputs.skip == 'false' && steps.lock_check.outputs.skip == 'false' && steps.idempotency_check.outputs.skip == 'false' && steps.access_check.outputs.skip == 'false' && steps.command_check.outputs.skip == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api --method POST -H "Accept: application/vnd.github+json" /repos/${{ github.repository }}/issues/24/comments -f body="$LLM_RESPONSE"
          echo "::notice::Posted"

      - name: Release Lock on Success
        id: release_success
        if: success() && steps.bot_check.outputs.skip == 'false' && steps.lock_check.outputs.skip == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api --method DELETE /repos/${{ github.repository }}/issues/24/labels/processing 2>/dev/null || true
          gh api --method POST /repos/${{ github.repository }}/issues/24/labels -f labels[]="complete"
          echo "::notice::Lock released: complete"

      - name: Release Lock on Failure
        id: release_failure
        if: failure() && steps.bot_check.outputs.skip == 'false' && steps.lock_check.outputs.skip == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api --method DELETE /repos/${{ github.repository }}/issues/24/labels/processing 2>/dev/null || true
          gh api --method POST /repos/${{ github.repository }}/issues/24/labels -f labels[]="error"
          echo "::notice::Lock released: error"

      - name: Report Failure
        if: |
          always() &&
          failure() &&
          github.event_name == 'issue_comment' &&
          github.event.issue.number == 24
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Determine failure cause
          CAUSE="Unknown failure"

          if [ "${{ steps.checkout.outcome }}" == "failure" ]; then
            CAUSE="Checkout failed"
          elif [ "${{ steps.auth_gcp.outcome }}" == "failure" ]; then
            CAUSE="GCP authentication failed"
          elif [ "${{ steps.secrets.outcome }}" == "failure" ]; then
            CAUSE="Secret retrieval failed"
          elif [ "${{ steps.setup_python.outcome }}" == "failure" ]; then
            CAUSE="Python setup failed"
          elif [ "${{ steps.install_deps.outcome }}" == "failure" ]; then
            CAUSE="Dependency installation failed"
          elif [ "${{ steps.generate_response.outcome }}" == "failure" ]; then
            CAUSE="LLM request failed (all retries exhausted)"
          elif [ "${{ steps.post_response.outcome }}" == "failure" ]; then
            CAUSE="Failed to post response"
          elif [ "${{ steps.acquire_lock.outcome }}" == "failure" ]; then
            CAUSE="Failed to acquire lock"
          fi

          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          FAILURE_COMMENT="❌ **Workflow Failed**

**Run:** ${RUN_URL}
**Cause:** ${CAUSE}
**Time:** ${TIMESTAMP}

<!-- P38_FAILURE_REPORT: run_${{ github.run_id }} -->"

          gh api --method POST \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/issues/24/comments \
            -f body="$FAILURE_COMMENT" || echo "::error::Failed to post failure report"

          echo "::notice::Failure report posted"
