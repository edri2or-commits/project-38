# Railway Environment Setup Wizard

**Zero-Touch Configuration for Project 38 (with GCP Auto-Discovery)**

## Overview
Fully automated PowerShell wizard with intelligent GCP Secret Manager integration:
- üîç **Auto-discovers LLM API keys from GCP** (zero manual input required)
- üîê Auto-generates secure passwords (PostgreSQL, Redis, SECRET_KEY)
- üìÑ Creates `.env.production` file
- üöÄ Optionally chains to `deploy_railway.ps1`
- ‚èÆÔ∏è Falls back to interactive prompts if GCP secrets unavailable

## Quick Start

### Zero-Touch Mode (Recommended)
If you have API keys stored in GCP Secret Manager:
```powershell
.\scripts\deployment\setup_env.ps1
```
**Result:** Script auto-discovers keys, generates passwords, creates config, deploys to Railway - **ZERO manual input required!** ‚ú®

### Interactive Mode (Fallback)
If GCP secrets not available, script will prompt for keys:
```powershell
.\scripts\deployment\setup_env.ps1
```

## Requirements
- **PowerShell 5.1+** (built-in on Windows)
- **gcloud CLI** (optional, for GCP auto-discovery)
  - Install: `choco install gcloudsdk` or download from [Google Cloud SDK](https://cloud.google.com/sdk)
- **openssl** (optional, for cryptographically secure password generation)
  - Falls back to PowerShell's `System.Security.Cryptography.RNGCryptoServiceProvider`

## GCP Secret Manager Integration

### Supported Secret Names
The wizard tries multiple naming conventions automatically:

| Provider | Secret Name Variants (in order) |
|----------|--------------------------------|
| OpenAI | `OPENAI_API_KEY` ‚Üí `openai_api_key` ‚Üí `openai-api-key` |
| Anthropic | `ANTHROPIC_API_KEY` ‚Üí `anthropic_api_key` ‚Üí `anthropic-api-key` |

### Setup GCP Secrets (One-Time)
```bash
# Store OpenAI key
echo -n "sk-..." | gcloud secrets create OPENAI_API_KEY \
  --data-file=- \
  --project=project-38-ai

# Store Anthropic key (optional)
echo -n "sk-ant-..." | gcloud secrets create ANTHROPIC_API_KEY \
  --data-file=- \
  --project=project-38-ai
```

**After setup:** Run `.\scripts\deployment\setup_env.ps1` with zero input! üéâ

### How Auto-Discovery Works
1. **Check gcloud:** Verifies `gcloud` CLI is available
2. **Try variants:** Tests all naming conventions for each provider
3. **Validate format:** Ensures discovered keys match expected format
4. **Fallback gracefully:** Prompts for manual input if discovery fails
5. **Continue normally:** Generates passwords and creates config

## Usage Examples

### Standard Zero-Touch Setup
```powershell
.\scripts\deployment\setup_env.ps1
```
Auto-discovers keys from GCP, generates all passwords, deploys.

### Skip GCP Discovery (Force Interactive)
```powershell
.\scripts\deployment\setup_env.ps1 -SkipGcpDiscovery
```

### Custom GCP Project
```powershell
.\scripts\deployment\setup_env.ps1 -GcpProject "my-custom-project"
```

### Skip Deployment Prompt
```powershell
.\scripts\deployment\setup_env.ps1 -SkipDeploy
```

### Force Regenerate Existing Config
```powershell
.\scripts\deployment\setup_env.ps1 -RegenerateAll
```

### Custom Output Path
```powershell
.\scripts\deployment\setup_env.ps1 -EnvFile "custom\.env.production"
```

### Complete Zero-Touch Example
```powershell
# One-time GCP setup (store your keys)
echo -n "sk-..." | gcloud secrets create OPENAI_API_KEY --data-file=-

# Every deployment after = ZERO INPUT! üöÄ
.\scripts\deployment\setup_env.ps1
```

## What Gets Generated

### Automatic (No User Input)
- `POSTGRES_USER=dify`
- `POSTGRES_DB=dify`
- `POSTGRES_PASSWORD` (32-char base64)
- `REDIS_PASSWORD` (32-char base64)
- `SECRET_KEY` (64-char hex)

### Auto-Discovered OR Interactive Prompts
- `OPENAI_API_KEY` (auto-discovered from GCP, or format: `sk-...`)
- `ANTHROPIC_API_KEY` (auto-discovered from GCP, or format: `sk-ant-...`)

**Note:** At least ONE LLM provider API key is required.

## Security Features
- ‚úÖ GCP Secret Manager integration (secure remote storage)
- ‚úÖ Cryptographically secure random generation (openssl or .NET RNG)
- ‚úÖ Input validation with regex patterns
- ‚úÖ Masked password display in summary
- ‚úÖ `.env.production` excluded from git (via `.gitignore`)
- ‚úÖ No secrets stored in script code

## Output
Creates `infrastructure/.env.production`:
```env
# PostgreSQL Configuration
POSTGRES_USER=dify
POSTGRES_PASSWORD=<auto-generated-32-chars>
POSTGRES_DB=dify

# Redis Configuration
REDIS_PASSWORD=<auto-generated-32-chars>

# Dify Application Secrets
SECRET_KEY=<auto-generated-64-chars>

# LLM Provider API Keys
OPENAI_API_KEY=<auto-discovered-or-user-provided>
ANTHROPIC_API_KEY=<auto-discovered-or-user-provided>
```

## Chaining to Deployment
After successful setup, wizard offers to launch:
```powershell
.\scripts\deployment\deploy_railway.ps1
```

To deploy manually later:
```powershell
.\scripts\deployment\deploy_railway.ps1 -EnvFile infrastructure\.env.production
```

## Troubleshooting

### "gcloud CLI not available" Warning
**Impact:** Falls back to interactive prompts for API keys  
**Fix (optional):** Install gcloud SDK:
```powershell
choco install gcloudsdk
# OR download from: https://cloud.google.com/sdk
```

### GCP Secret Not Found
**Symptoms:** Script prompts for manual input despite having gcloud installed  
**Common Causes:**
- Secret doesn't exist in GCP project
- Wrong project selected (default: `project-38-ai`)
- Incorrect secret name format

**Solutions:**
1. **Verify secret exists:**
   ```bash
   gcloud secrets list --project=project-38-ai
   ```

2. **Check secret value:**
   ```bash
   gcloud secrets versions access latest \
     --secret="OPENAI_API_KEY" \
     --project=project-38-ai
   ```

3. **Create missing secret:**
   ```bash
   echo -n "sk-..." | gcloud secrets create OPENAI_API_KEY \
     --data-file=- \
     --project=project-38-ai
   ```

4. **Use custom project:**
   ```powershell
   .\setup_env.ps1 -GcpProject "your-project-id"
   ```

### "openssl not found" Warning
**Impact:** Uses PowerShell fallback RNG (still cryptographically secure)  
**Fix (optional):** Install openssl via Chocolatey:
```powershell
choco install openssl
```

### API Key Format Validation Failed
- **OpenAI:** Must start with `sk-` (at least 32 chars)
- **Anthropic:** Must start with `sk-ant-` (at least 90 chars)
- **GCP secret:** Ensure stored value has correct format
- Wizard offers to continue anyway if format looks wrong

### "At least one LLM provider API key is required"
**Solution:** Provide either OpenAI OR Anthropic key (or both)  
**Options:**
1. Store in GCP Secret Manager (recommended):
   ```bash
   echo -n "sk-..." | gcloud secrets create OPENAI_API_KEY --data-file=-
   ```
2. Get keys from:
   - OpenAI: https://platform.openai.com/api-keys
   - Anthropic: https://console.anthropic.com/settings/keys

## Advanced Configuration

### Parameters Reference
| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `-SkipDeploy` | Switch | False | Skip Railway deployment prompt |
| `-RegenerateAll` | Switch | False | Overwrite existing .env without confirmation |
| `-SkipGcpDiscovery` | Switch | False | Force interactive mode (disable GCP auto-discovery) |
| `-EnvFile` | String | `infrastructure\.env.production` | Custom output path |
| `-GcpProject` | String | `project-38-ai` | GCP project for secret lookup |

### Examples
```powershell
# Silent regeneration with GCP auto-discovery
.\setup_env.ps1 -RegenerateAll -SkipDeploy

# Test with different GCP project
.\setup_env.ps1 -GcpProject "staging-project"

# Force interactive (ignore GCP)
.\setup_env.ps1 -SkipGcpDiscovery

# Complete custom setup
.\setup_env.ps1 `
  -GcpProject "custom-project" `
  -EnvFile "staging\.env.staging" `
  -SkipDeploy
```

## Workflow Comparison

### Before (Manual)
1. Copy `.env.template` ‚Üí `.env.production`
2. Manually edit 8 variables
3. Generate passwords with external tools
4. Validate formats manually
5. Run deployment script
**Time:** ~5-10 minutes, high error risk

### After (Zero-Touch)
1. Run `.\setup_env.ps1`
**Time:** ~10 seconds, zero errors! ‚ú®

## See Also
- [Railway Deployment Guide](README_deploy_railway.md) - Full deployment process
- [Environment Template](.env.template) - All available variables
- [Infrastructure README](../../infrastructure/README.md) - Setup overview
- [GCP Secret Manager](https://cloud.google.com/secret-manager) - Secure secret storage
