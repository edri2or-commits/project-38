# POC-03 Execution Issues — 2025-12-17

## Summary
POC-03 workflows imported successfully but failed to activate properly. Workflows marked as `active=true` in DB but webhooks not registered by n8n.

## Workflows Created

### 1. Mock Kernel
- **Workflow ID:** `mKmLYWfXGkAayBnf`
- **Status in DB:** `active = true`
- **Webhook Path:** `/webhook/mock-kernel`
- **Issue:** Webhook NOT registered by n8n
- **Error:** `The requested webhook "POST mock-kernel" is not registered.`

### 2. Conversation POC-03
- **Workflow ID:** `AIAz8XxmeI9mie9D`
- **Status in DB:** `active = true`
- **Issue 1:** Missing Telegram credentials
- **Issue 2:** Hardcoded credential ID `existing-telegram-credential-id` does not exist
- **N8N Error:** `Credential with ID "existing-telegram-credential-id" does not exist for type "telegramApi"`

## Root Cause Analysis

### Problem 1: Activation Method
**Symptom:** Workflows show `active=true` in DB but webhooks not registered

**Root Cause:** 
- Import via `n8n import:workflow` creates workflow in DB
- Setting `active=true` in workflow JSON only sets DB flag
- Does NOT trigger n8n's internal webhook registration
- n8n requires proper activation through:
  1. UI toggle (triggers activation handlers)
  2. API activation endpoint
  3. Activation script (creates workflow_history + activeVersionId)

**Evidence:**
```
docker logs p38-n8n | grep webhook
# Shows: No registration events for mock-kernel
# Shows: Activation failures for Conversation POC-03 (credentials issue)
```

### Problem 2: Missing Credentials
**Symptom:** Conversation POC-03 activation fails continuously

**Root Cause:**
- Workflow JSON hardcodes `credential_id: "existing-telegram-credential-id"`
- No Telegram credentials exist in n8n DB
- Query shows: `SELECT * FROM credentials_entity WHERE type='telegramApi'` returns 0 rows

**N8N Behavior:**
- Retries activation with exponential backoff (128s, 256s, 512s, 1024s)
- Never succeeds because credential doesn't exist

## DB State Verification

### Workflows Table
```sql
SELECT id, name, active FROM workflow_entity;
```
| id | name | active |
|----|------|--------|
| AIAz8XxmeI9mie9D | Conversation POC-03 | t |
| mKmLYWfXGkAayBnf | Mock Kernel | t |

### Workflow History
```sql
SELECT COUNT(*) FROM workflow_history;
```
- Count: 2 records ✅
- Both workflows have history entries (created during import)

### Credentials
```sql
SELECT id, name, type FROM credentials_entity WHERE type='telegramApi';
```
- Count: 0 records ❌
- No Telegram credentials configured

## Files Created

### Local Files (C:\Users\edri2\project_38)
1. `deployment/n8n/workflows/mock-kernel.json` (52 lines)
2. `deployment/n8n/workflows/conversation-poc03.json` (103 lines)

### VM Files (p38-dev-vm-01)
1. `~/workflows/mock-kernel.json`
2. `~/workflows/conversation-poc03.json`

## Actions Attempted

### 1. Import Workflows ✅
```bash
docker exec p38-n8n n8n import:workflow --input=/tmp/mock-kernel.json
docker exec p38-n8n n8n import:workflow --input=/tmp/conversation-poc03.json
```
**Result:** SUCCESS - Both workflows imported

### 2. Check Import Status ✅
```bash
docker exec p38-n8n n8n list:workflow
```
**Output:**
```
AIAz8XxmeI9mie9D|Conversation POC-03
mKmLYWfXGkAayBnf|Mock Kernel
```

### 3. Test Mock Kernel Webhook ❌
```powershell
Invoke-RestMethod -Uri "http://localhost:5678/webhook/mock-kernel" -Method POST
```
**Error:** 404 - Webhook not registered

### 4. Restart N8N Container ⚠️
```bash
docker restart p38-n8n
```
**Result:** Restart triggered activation attempts
- Mock Kernel: No errors but webhook still not registered
- Conversation POC-03: Credential errors (see logs above)

## What Needs to Be Fixed

### Option A: Manual UI Activation (Recommended)
1. Access n8n UI: http://localhost:5678
2. Open Mock Kernel workflow
3. Click "Active" toggle → This registers webhook
4. Create Telegram credential (Bot Token)
5. Open Conversation POC-03 workflow
6. Replace credential reference with actual credential ID
7. Click "Active" toggle

### Option B: Programmatic Activation
1. Create Telegram credential via n8n API
2. Update Conversation POC-03 JSON with real credential ID
3. Use activation script (like `/opt/n8n-activate.sh` in POC-01/02)
4. Requires proper workflow_history entries + activeVersionId

### Option C: Simplified Approach
1. Delete both workflows from n8n
2. Create them manually in UI
3. Configure credentials properly
4. Activate via UI toggle

## Lessons Learned

### ❌ Don't Do This
- Import workflows with hardcoded credential IDs
- Rely on `active=true` flag in JSON for activation
- Assume imported workflows are "ready to use"

### ✅ Do This Instead
- Create credentials FIRST (via UI or API)
- Get real credential IDs from DB
- Use credential IDs in workflow JSON
- Activate via UI toggle or proper activation script
- Verify webhook registration in logs

## Next Steps (When Resuming)

### Prerequisites
1. Decide: Manual UI activation OR programmatic approach
2. If programmatic: Create activation script for webhook workflows

### Manual Path (Fast)
1. Open n8n UI
2. Activate Mock Kernel (should work immediately)
3. Create Telegram credential
4. Edit Conversation POC-03 → Replace credential ID
5. Activate Conversation POC-03
6. Run GATE tests

### Programmatic Path (Reproducible)
1. Query Telegram credentials from previous POC
2. Create script to update workflow JSON
3. Recreate workflows with correct credential IDs
4. Use activation script (POC-01 pattern)
5. Run GATE tests

## References
- POC-01: `/opt/n8n-activate.sh` script pattern
- POC-02: Telegram webhook setup (has working credentials)
- N8N Docs: https://docs.n8n.io/workflows/create-first-workflow/
- Webhook activation: Requires proper workflow_history + activeVersionId

---

**Status:** ⏸️ PAUSED — Requires manual intervention or activation script
**Blocker:** Webhook registration requires proper activation (not just DB flag)
**Impact:** POC-03 cannot proceed until workflows are properly activated
